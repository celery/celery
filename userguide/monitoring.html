<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Monitoring and Management Guide &mdash; Celery 2.4.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/issuetracker.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Celery 2.4.0 documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Optimizing" href="optimizing.html" />
    <link rel="prev" title="Routing Tasks" href="routing.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optimizing.html" title="Optimizing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="routing.html" title="Routing Tasks"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Celery 2.4.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">User Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
<div class="deck">

    
        <p>
        This document describes Celery 2.4. For development docs,
        <a href="http://ask.github.com/celery/en/master/userguide/monitoring.html">go here</a>.
        </p>
    

</div>
    <div class="section" id="monitoring-and-management-guide">
<span id="guide-monitoring"></span><h1>Monitoring and Management Guide<a class="headerlink" href="#monitoring-and-management-guide" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#workers" id="id3">Workers</a><ul>
<li><a class="reference internal" href="#celeryctl-management-utility" id="id4">celeryctl: Management Utility</a><ul>
<li><a class="reference internal" href="#commands" id="id5">Commands</a></li>
<li><a class="reference internal" href="#specifying-destination-nodes" id="id6">Specifying destination nodes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#django-admin-monitor" id="id7">Django Admin Monitor</a><ul>
<li><a class="reference internal" href="#starting-the-monitor" id="id8">Starting the monitor</a></li>
<li><a class="reference internal" href="#shutter-frequency" id="id9">Shutter frequency</a></li>
<li><a class="reference internal" href="#using-outside-of-django" id="id10">Using outside of Django</a></li>
</ul>
</li>
<li><a class="reference internal" href="#celeryev-curses-monitor" id="id11">celeryev: Curses Monitor</a></li>
<li><a class="reference internal" href="#celerymon-web-monitor" id="id12">celerymon: Web monitor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rabbitmq" id="id13">RabbitMQ</a><ul>
<li><a class="reference internal" href="#inspecting-queues" id="id14">Inspecting queues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#munin" id="id15">Munin</a></li>
<li><a class="reference internal" href="#events" id="id16">Events</a><ul>
<li><a class="reference internal" href="#snapshots" id="id17">Snapshots</a><ul>
<li><a class="reference internal" href="#custom-camera" id="id18">Custom Camera</a></li>
</ul>
</li>
<li><a class="reference internal" href="#event-reference" id="id19">Event Reference</a><ul>
<li><a class="reference internal" href="#task-events" id="id20">Task Events</a></li>
<li><a class="reference internal" href="#worker-events" id="id21">Worker Events</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>There are several tools available to monitor and inspect Celery clusters.</p>
<p>This document describes some of these, as as well as
features related to monitoring, like events and broadcast commands.</p>
</div>
<div class="section" id="workers">
<span id="monitoring-workers"></span><h2><a class="toc-backref" href="#id3">Workers</a><a class="headerlink" href="#workers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="celeryctl-management-utility">
<span id="monitoring-celeryctl"></span><h3><a class="toc-backref" href="#id4">celeryctl: Management Utility</a><a class="headerlink" href="#celeryctl-management-utility" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<p><a class="reference internal" href="../reference/celery.bin.celeryctl.html#module-celery.bin.celeryctl" title="celery.bin.celeryctl"><tt class="xref py py-mod docutils literal"><span class="pre">celeryctl</span></tt></a> is a command line utility to inspect
and manage worker nodes (and to some degree tasks).</p>
<p>To list all the commands available do:</p>
<div class="highlight-python"><pre>$ celeryctl help</pre>
</div>
<p>or to get help for a specific command do:</p>
<div class="highlight-python"><pre>$ celeryctl &lt;command&gt; --help</pre>
</div>
<div class="section" id="commands">
<h4><a class="toc-backref" href="#id5">Commands</a><a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h4>
<ul>
<li><dl class="first docutils">
<dt><strong>status</strong>: List active nodes in this cluster</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl status</pre>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>result</strong>: Show the result of a task</dt>
<dd><div class="first highlight-python"><pre>$ celeryctl result -t tasks.add 4e196aa4-0141-4601-8138-7aa33db0f577</pre>
</div>
<p class="last">Note that you can omit the name of the task as long as the
task doesn&#8217;t use a custom result backend.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>purge</strong>: Purge messages from all configured task queues.</dt>
<dd><div class="first highlight-python"><pre>$ celeryctl purge</pre>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is no undo for this operation, and messages will
be permanently deleted!</p>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect active</strong>: List active tasks</dt>
<dd><div class="first highlight-python"><pre>$ celeryctl inspect active</pre>
</div>
<p class="last">These are all the tasks that are currently being executed.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect scheduled</strong>: List scheduled ETA tasks</dt>
<dd><div class="first highlight-python"><pre>$ celeryctl inspect scheduled</pre>
</div>
<p class="last">These are tasks reserved by the worker because they have the
<cite>eta</cite> or <cite>countdown</cite> argument set.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect reserved</strong>: List reserved tasks</dt>
<dd><div class="first highlight-python"><pre>$ celeryctl inspect reserved</pre>
</div>
<p class="last">This will list all tasks that have been prefetched by the worker,
and is currently waiting to be executed (does not include tasks
with an eta).</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect revoked</strong>: List history of revoked tasks</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl inspect revoked</pre>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect registered</strong>: List registered tasks</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl inspect registered</pre>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect stats</strong>: Show worker statistics</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl inspect stats</pre>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect enable_events</strong>: Enable events</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl inspect enable_events</pre>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>inspect disable_events</strong>: Disable events</dt>
<dd><div class="first last highlight-python"><pre>$ celeryctl inspect disable_events</pre>
</div>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All <tt class="docutils literal"><span class="pre">inspect</span></tt> commands supports a <tt class="docutils literal"><span class="pre">--timeout</span></tt> argument,
This is the number of seconds to wait for responses.
You may have to increase this timeout if you&#8217;re not getting a response
due to latency.</p>
</div>
</div>
<div class="section" id="specifying-destination-nodes">
<span id="celeryctl-inspect-destination"></span><h4><a class="toc-backref" href="#id6">Specifying destination nodes</a><a class="headerlink" href="#specifying-destination-nodes" title="Permalink to this headline">¶</a></h4>
<p>By default the inspect commands operates on all workers.
You can specify a single, or a list of workers by using the
<cite>&#8211;destination</cite> argument:</p>
<div class="highlight-python"><pre>$ celeryctl inspect -d w1,w2 reserved</pre>
</div>
</div>
</div>
<div class="section" id="django-admin-monitor">
<span id="monitoring-django-admin"></span><h3><a class="toc-backref" href="#id7">Django Admin Monitor</a><a class="headerlink" href="#django-admin-monitor" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<p>When you add <a class="reference external" href="http://pypi.python.org/pypi/django-celery">django-celery</a> to your Django project you will
automatically get a monitor section as part of the Django admin interface.</p>
<p>This can also be used if you&#8217;re not using Celery with a Django project.</p>
<p><em>Screenshot</em></p>
<div class="figure">
<img alt="../_images/djangoceleryadmin2.jpg" src="../_images/djangoceleryadmin2.jpg" />
</div>
<div class="section" id="starting-the-monitor">
<span id="monitoring-django-starting"></span><h4><a class="toc-backref" href="#id8">Starting the monitor</a><a class="headerlink" href="#starting-the-monitor" title="Permalink to this headline">¶</a></h4>
<p>The Celery section will already be present in your admin interface,
but you won&#8217;t see any data appearing until you start the snapshot camera.</p>
<p>The camera takes snapshots of the events your workers sends at regular
intervals, storing them in your database (See <a class="reference internal" href="#monitoring-snapshots"><em>Snapshots</em></a>).</p>
<p>To start the camera run:</p>
<div class="highlight-python"><pre>$ python manage.py celerycam</pre>
</div>
<p>If you haven&#8217;t already enabled the sending of events you need to do so:</p>
<div class="highlight-python"><pre>$ python manage.py celeryctl inspect enable_events</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">You can enable events when the worker starts using the <cite>-E</cite> argument
to <a class="reference internal" href="../reference/celery.bin.celeryd.html#module-celery.bin.celeryd" title="celery.bin.celeryd"><tt class="xref py py-mod docutils literal"><span class="pre">celeryd</span></tt></a>.</td>
</tr>
</tbody>
</table>
<p>Now that the camera has been started, and events have been enabled
you should be able to see your workers and the tasks in the admin interface
(it may take some time for workers to show up).</p>
<p>The admin interface shows tasks, worker nodes, and even
lets you perform some actions, like revoking and rate limiting tasks,
or shutting down worker nodes.</p>
</div>
<div class="section" id="shutter-frequency">
<span id="monitoring-django-frequency"></span><h4><a class="toc-backref" href="#id9">Shutter frequency</a><a class="headerlink" href="#shutter-frequency" title="Permalink to this headline">¶</a></h4>
<p>By default the camera takes a snapshot every second, if this is too frequent
or you want to have higher precision, then you can change this using the
<tt class="docutils literal"><span class="pre">--frequency</span></tt> argument.  This is a float describing how often, in seconds,
it should wake up to check if there are any new events:</p>
<div class="highlight-python"><pre>$ python manage.py celerycam --frequency=3.0</pre>
</div>
<p>The camera also supports rate limiting using the <tt class="docutils literal"><span class="pre">--maxrate</span></tt> argument.
While the frequency controls how often the camera thread wakes up,
the rate limit controls how often it will actually take a snapshot.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <cite>/s</cite>, <cite>/m</cite> or <cite>/h</cite> to the value.
Example: <tt class="docutils literal"><span class="pre">--maxrate=100/m</span></tt>, means &#8220;hundred writes a minute&#8221;.</p>
<p>The rate limit is off by default, which means it will take a snapshot
for every <tt class="docutils literal"><span class="pre">--frequency</span></tt> seconds.</p>
<p>The events also expire after some time, so the database doesn&#8217;t fill up.
Successful tasks are deleted after 1 day, failed tasks after 3 days,
and tasks in other states after 5 days.</p>
</div>
<div class="section" id="using-outside-of-django">
<span id="monitoring-nodjango"></span><h4><a class="toc-backref" href="#id10">Using outside of Django</a><a class="headerlink" href="#using-outside-of-django" title="Permalink to this headline">¶</a></h4>
<p><cite>django-celery</cite> also installs the <strong class="program">djcelerymon</strong> program. This
can be used by non-Django users, and runs both a web server and a snapshot
camera in the same process.</p>
<p><strong>Installing</strong></p>
<p>Using <strong class="program">pip</strong>:</p>
<div class="highlight-python"><pre>$ pip install -U django-celery</pre>
</div>
<p>or using <strong class="program">easy_install</strong>:</p>
<div class="highlight-python"><pre>$ easy_install -U django-celery</pre>
</div>
<p><strong>Running</strong></p>
<p><strong class="program">djcelerymon</strong> reads configuration from your Celery configuration
module, and sets up the Django environment using the same settings:</p>
<div class="highlight-python"><pre>$ djcelerymon</pre>
</div>
<p>Database tables will be created the first time the monitor is run.
By default an <cite>sqlite3</cite> database file named
<tt class="file docutils literal"><span class="pre">djcelerymon.db</span></tt> is used, so make sure this file is writeable by the
user running the monitor.</p>
<p>If you want to store the events in a different database, e.g. MySQL,
then you can configure the <cite>DATABASE*</cite> settings directly in your Celery
config module.  See <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#databases">http://docs.djangoproject.com/en/dev/ref/settings/#databases</a>
for more information about the database options available.</p>
<p>You will also be asked to create a superuser (and you need to create one
to be able to log into the admin later):</p>
<div class="highlight-python"><pre>Creating table auth_permission
Creating table auth_group_permissions
[...]

You just installed Django's auth system, which means you don't
have any superusers defined.  Would you like to create
one now? (yes/no): yes
Username (Leave blank to use 'username'): username
Email address: me@example.com
Password: ******
Password (again): ******
Superuser created successfully.

[...]
Django version 1.2.1, using settings 'celeryconfig'
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.</pre>
</div>
<p>Now that the service is started you can visit the monitor
at <a class="reference external" href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>, and log in using the user you created.</p>
<p>For a list of the command line options supported by <strong class="program">djcelerymon</strong>,
please see <tt class="docutils literal"><span class="pre">djcelerymon</span> <span class="pre">--help</span></tt>.</p>
</div>
</div>
<div class="section" id="celeryev-curses-monitor">
<span id="monitoring-celeryev"></span><h3><a class="toc-backref" href="#id11">celeryev: Curses Monitor</a><a class="headerlink" href="#celeryev-curses-monitor" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.0.</span></p>
<p><a class="reference internal" href="../reference/celery.bin.celeryev.html#module-celery.bin.celeryev" title="celery.bin.celeryev"><tt class="xref py py-mod docutils literal"><span class="pre">celeryev</span></tt></a> is a simple curses monitor displaying
task and worker history.  You can inspect the result and traceback of tasks,
and it also supports some management commands like rate limiting and shutting
down workers.</p>
<div class="figure">
<img alt="../_images/celeryevshotsm1.jpg" src="../_images/celeryevshotsm1.jpg" />
</div>
<p><a class="reference internal" href="../reference/celery.bin.celeryev.html#module-celery.bin.celeryev" title="celery.bin.celeryev"><tt class="xref py py-mod docutils literal"><span class="pre">celeryev</span></tt></a> is also used to start snapshot cameras (see
<a class="reference internal" href="#monitoring-snapshots"><em>Snapshots</em></a>:</p>
<div class="highlight-python"><pre>$ celeryev --camera=&lt;camera-class&gt; --frequency=1.0</pre>
</div>
<p>and it includes a tool to dump events to <tt class="file docutils literal"><span class="pre">stdout</span></tt>:</p>
<div class="highlight-python"><pre>$ celeryev --dump</pre>
</div>
<p>For a complete list of options use <tt class="docutils literal"><span class="pre">--help</span></tt>:</p>
<div class="highlight-python"><pre>$ celeryev --help</pre>
</div>
</div>
<div class="section" id="celerymon-web-monitor">
<span id="monitoring-celerymon"></span><h3><a class="toc-backref" href="#id12">celerymon: Web monitor</a><a class="headerlink" href="#celerymon-web-monitor" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://github.com/ask/celerymon/">celerymon</a> is the ongoing work to create a web monitor.
It&#8217;s far from complete yet, and does currently only support
a JSON API.  Help is desperately needed for this project, so if you,
or someone you know would like to contribute templates, design, code
or help this project in any way, please get in touch!</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">The Django admin monitor can be used even though you&#8217;re not using
Celery with a Django project.  See <a class="reference internal" href="#monitoring-nodjango"><em>Using outside of Django</em></a>.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="rabbitmq">
<span id="monitoring-rabbitmq"></span><h2><a class="toc-backref" href="#id13">RabbitMQ</a><a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h2>
<p>To manage a Celery cluster it is important to know how
RabbitMQ can be monitored.</p>
<p>RabbitMQ ships with the <a class="reference external" href="http://www.rabbitmq.com/man/rabbitmqctl.1.man.html">rabbitmqctl(1)</a> command,
with this you can list queues, exchanges, bindings,
queue lengths, the memory usage of each queue, as well
as manage users, virtual hosts and their permissions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default virtual host (<tt class="docutils literal"><span class="pre">&quot;/&quot;</span></tt>) is used in these
examples, if you use a custom virtual host you have to add
the <tt class="docutils literal"><span class="pre">-p</span></tt> argument to the command, e.g:
<tt class="docutils literal"><span class="pre">rabbitmqctl</span> <span class="pre">list_queues</span> <span class="pre">-p</span> <span class="pre">my_vhost</span> <span class="pre">....</span></tt></p>
</div>
<div class="section" id="inspecting-queues">
<span id="monitoring-rmq-queues"></span><h3><a class="toc-backref" href="#id14">Inspecting queues</a><a class="headerlink" href="#inspecting-queues" title="Permalink to this headline">¶</a></h3>
<p>Finding the number of tasks in a queue:</p>
<div class="highlight-python"><pre>$ rabbitmqctl list_queues name messages messages_ready \
                          messages_unacknowlged</pre>
</div>
<p>Here <cite>messages_ready</cite> is the number of messages ready
for delivery (sent but not received), <cite>messages_unacknowledged</cite>
is the number of messages that has been received by a worker but
not acknowledged yet (meaning it is in progress, or has been reserved).
<cite>messages</cite> is the sum of ready and unacknowledged messages.</p>
<p>Finding the number of workers currently consuming from a queue:</p>
<div class="highlight-python"><pre>$ rabbitmqctl list_queues name consumers</pre>
</div>
<p>Finding the amount of memory allocated to a queue:</p>
<div class="highlight-python"><pre>$ rabbitmqctl list_queues name memory</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">Adding the <tt class="docutils literal"><span class="pre">-q</span></tt> option to <a class="reference external" href="http://www.rabbitmq.com/man/rabbitmqctl.1.man.html">rabbitmqctl(1)</a> makes the output
easier to parse.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="munin">
<span id="monitoring-munin"></span><h2><a class="toc-backref" href="#id15">Munin</a><a class="headerlink" href="#munin" title="Permalink to this headline">¶</a></h2>
<p>This is a list of known Munin plug-ins that can be useful when
maintaining a Celery cluster.</p>
<ul>
<li><p class="first">rabbitmq-munin: Munin plug-ins for RabbitMQ.</p>
<blockquote>
<div><p><a class="reference external" href="http://github.com/ask/rabbitmq-munin">http://github.com/ask/rabbitmq-munin</a></p>
</div></blockquote>
</li>
<li><p class="first">celery_tasks: Monitors the number of times each task type has
been executed (requires <cite>celerymon</cite>).</p>
<blockquote>
<div><p><a class="reference external" href="http://exchange.munin-monitoring.org/plugins/celery_tasks-2/details">http://exchange.munin-monitoring.org/plugins/celery_tasks-2/details</a></p>
</div></blockquote>
</li>
<li><p class="first">celery_task_states: Monitors the number of tasks in each state
(requires <cite>celerymon</cite>).</p>
<blockquote>
<div><p><a class="reference external" href="http://exchange.munin-monitoring.org/plugins/celery_tasks/details">http://exchange.munin-monitoring.org/plugins/celery_tasks/details</a></p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="events">
<span id="monitoring-events"></span><h2><a class="toc-backref" href="#id16">Events</a><a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>The worker has the ability to send a message whenever some event
happens.  These events are then captured by tools like <strong class="program">celerymon</strong>
and <strong class="program">celeryev</strong> to monitor the cluster.</p>
<div class="section" id="snapshots">
<span id="monitoring-snapshots"></span><h3><a class="toc-backref" href="#id17">Snapshots</a><a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h3>
<p>Even a single worker can produce a huge amount of events, so storing
the history of all events on disk may be very expensive.</p>
<p>A sequence of events describes the cluster state in that time period,
by taking periodic snapshots of this state we can keep all history, but
still only periodically write it to disk.</p>
<p>To take snapshots you need a Camera class, with this you can define
what should happen every time the state is captured;  You can
write it to a database, send it by email or something else entirely.</p>
<p><strong class="program">celeryev</strong> is then used to take snapshots with the camera,
for example if you want to capture state every 2 seconds using the
camera <tt class="docutils literal"><span class="pre">myapp.Camera</span></tt> you run <strong class="program">celeryev</strong> with the following
arguments:</p>
<div class="highlight-python"><pre>$ celeryev -c myapp.Camera --frequency=2.0</pre>
</div>
<div class="section" id="custom-camera">
<span id="monitoring-camera"></span><h4><a class="toc-backref" href="#id18">Custom Camera</a><a class="headerlink" href="#custom-camera" title="Permalink to this headline">¶</a></h4>
<p>Here is an example camera, dumping the snapshot to screen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="kn">from</span> <span class="nn">celery.events.snapshot</span> <span class="kn">import</span> <span class="n">Polaroid</span>


<span class="k">class</span> <span class="nc">DumpCam</span><span class="p">(</span><span class="n">Polaroid</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_shutter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">event_count</span><span class="p">:</span>
            <span class="c"># No new events since last snapshot.</span>
            <span class="k">return</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Workers: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Tasks: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Total: </span><span class="si">%s</span><span class="s"> events, </span><span class="si">%s</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">event_count</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">task_count</span><span class="p">))</span>
</pre></div>
</div>
<p>See the API reference for <a class="reference internal" href="../reference/celery.events.state.html#module-celery.events.state" title="celery.events.state"><tt class="xref py py-mod docutils literal"><span class="pre">celery.events.state</span></tt></a> to read more
about state objects.</p>
<p>Now you can use this cam with <strong class="program">celeryev</strong> by specifying
it with the <cite>-c</cite> option:</p>
<div class="highlight-python"><pre>$ celeryev -c myapp.DumpCam --frequency=2.0</pre>
</div>
<p>Or you can use it programmatically like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.events</span> <span class="kn">import</span> <span class="n">EventReceiver</span>
<span class="kn">from</span> <span class="nn">celery.messaging</span> <span class="kn">import</span> <span class="n">establish_connection</span>
<span class="kn">from</span> <span class="nn">celery.events.state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">DumpCam</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">establish_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">EventReceiver</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">event</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">DumpCam</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="n">recv</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-reference">
<span id="id1"></span><h3><a class="toc-backref" href="#id19">Event Reference</a><a class="headerlink" href="#event-reference" title="Permalink to this headline">¶</a></h3>
<p>This list contains the events sent by the worker, and their arguments.</p>
<div class="section" id="task-events">
<span id="event-reference-task"></span><h4><a class="toc-backref" href="#id20">Task Events</a><a class="headerlink" href="#task-events" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-sent(uuid,</span> <span class="pre">name,</span> <span class="pre">args,</span> <span class="pre">kwargs,</span> <span class="pre">retries,</span> <span class="pre">eta,</span> <span class="pre">expires)</span></tt></p>
<blockquote>
<div><p>Sent when a task message is published and
the <a class="reference internal" href="../configuration.html#std:setting-CELERY_SEND_TASK_SENT_EVENT"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_SEND_TASK_SENT_EVENT</span></tt></a> setting is enabled.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-received(uuid,</span> <span class="pre">name,</span> <span class="pre">args,</span> <span class="pre">kwargs,</span> <span class="pre">retries,</span> <span class="pre">eta,</span> <span class="pre">hostname,</span>
<span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent when the worker receives a task.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-started(uuid,</span> <span class="pre">hostname,</span> <span class="pre">timestamp,</span> <span class="pre">pid)</span></tt></p>
<blockquote>
<div><p>Sent just before the worker executes the task.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-succeeded(uuid,</span> <span class="pre">result,</span> <span class="pre">runtime,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the task executed successfully.</p>
<p>Runtime is the time it took to execute the task using the pool.
(Starting from the task is sent to the worker pool, and ending when the
pool result handler callback is called).</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-failed(uuid,</span> <span class="pre">exception,</span> <span class="pre">traceback,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the execution of the task failed.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-revoked(uuid)</span></tt></p>
<blockquote>
<div><p>Sent if the task has been revoked (Note that this is likely
to be sent by more than one worker).</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-retried(uuid,</span> <span class="pre">exception,</span> <span class="pre">traceback,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the task failed, but will be retried in the future.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="worker-events">
<span id="event-reference-worker"></span><h4><a class="toc-backref" href="#id21">Worker Events</a><a class="headerlink" href="#worker-events" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-online(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>The worker has connected to the broker and is online.</p>
<ul class="simple">
<li><cite>sw_ident</cite>: Name of worker software (e.g. celeryd).</li>
<li><cite>sw_ver</cite>: Software version (e.g. 2.2.0).</li>
<li><cite>sw_sys</cite>: Operating System (e.g. Linux, Windows, Darwin).</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-heartbeat(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>Sent every minute, if the worker has not sent a heartbeat in 2 minutes,
it is considered to be offline.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-offline(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>The worker has disconnected from the broker.</p>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="http://cloud.github.com/downloads/ask/celery/celery_128.png" alt="Logo"/>
</a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="routing.html"
                        title="previous chapter">Routing Tasks</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="optimizing.html"
                        title="next chapter">Optimizing</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/userguide/monitoring.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optimizing.html" title="Optimizing"
             >next</a> |</li>
        <li class="right" >
          <a href="routing.html" title="Routing Tasks"
             >previous</a> |</li>
        <li><a href="../index.html">Celery 2.4.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >User Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2011, Ask Solem &amp; Contributors.
    </div>
  </body>
</html>