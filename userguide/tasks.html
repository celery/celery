<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tasks &mdash; Celery v2.3.0rc2 documentation</title>
    <link rel="stylesheet" href="../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/issuetracker.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.3.0rc2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Celery v2.3.0rc2 documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Executing Tasks" href="executing.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="executing.html" title="Executing Tasks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Celery v2.3.0rc2 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">User Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
<div class="deck">

    
        <p class="developmentversion">
        This document is for Celery's development version, which can be
        significantly different from previous releases. Get old docs here:

        <a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html">2.1</a>.
        </p>
        

</div>
    <div class="section" id="tasks">
<span id="guide-tasks"></span><h1>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#basics" id="id5">Basics</a></li>
<li><a class="reference internal" href="#context" id="id6">Context</a><ul>
<li><a class="reference internal" href="#example-usage" id="id7">Example Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logging" id="id8">Logging</a></li>
<li><a class="reference internal" href="#retrying-a-task-if-something-fails" id="id9">Retrying a task if something fails</a><ul>
<li><a class="reference internal" href="#using-a-custom-retry-delay" id="id10">Using a custom retry delay</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-options" id="id11">Task options</a><ul>
<li><a class="reference internal" href="#general" id="id12">General</a></li>
<li><a class="reference internal" href="#message-and-routing-options" id="id13">Message and routing options</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-names" id="id14">Task names</a><ul>
<li><a class="reference internal" href="#automatic-naming-and-relative-imports" id="id15">Automatic naming and relative imports</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decorating-tasks" id="id16">Decorating tasks</a></li>
<li><a class="reference internal" href="#task-states" id="id17">Task States</a><ul>
<li><a class="reference internal" href="#result-backends" id="id18">Result Backends</a><ul>
<li><a class="reference internal" href="#amqp-result-backend" id="id19">AMQP Result Backend</a></li>
<li><a class="reference internal" href="#database-result-backend" id="id20">Database Result Backend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#built-in-states" id="id21">Built-in States</a><ul>
<li><a class="reference internal" href="#pending" id="id22">PENDING</a></li>
<li><a class="reference internal" href="#started" id="id23">STARTED</a></li>
<li><a class="reference internal" href="#success" id="id24">SUCCESS</a></li>
<li><a class="reference internal" href="#failure" id="id25">FAILURE</a></li>
<li><a class="reference internal" href="#retry" id="id26">RETRY</a></li>
<li><a class="reference internal" href="#revoked" id="id27">REVOKED</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-states" id="id28">Custom states</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-custom-task-classes" id="id29">Creating custom task classes</a><ul>
<li><a class="reference internal" href="#instantiation" id="id30">Instantiation</a></li>
<li><a class="reference internal" href="#abstract-classes" id="id31">Abstract classes</a></li>
<li><a class="reference internal" href="#handlers" id="id32">Handlers</a><ul>
<li><a class="reference internal" href="#on-retry" id="id33">on_retry</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-it-works" id="id34">How it works</a></li>
<li><a class="reference internal" href="#tips-and-best-practices" id="id35">Tips and Best Practices</a><ul>
<li><a class="reference internal" href="#ignore-results-you-don-t-want" id="id36">Ignore results you don&#8217;t want</a></li>
<li><a class="reference internal" href="#disable-rate-limits-if-they-re-not-used" id="id37">Disable rate limits if they&#8217;re not used</a></li>
<li><a class="reference internal" href="#avoid-launching-synchronous-subtasks" id="id38">Avoid launching synchronous subtasks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-and-strategies" id="id39">Performance and Strategies</a><ul>
<li><a class="reference internal" href="#granularity" id="id40">Granularity</a></li>
<li><a class="reference internal" href="#data-locality" id="id41">Data locality</a></li>
<li><a class="reference internal" href="#state" id="id42">State</a></li>
<li><a class="reference internal" href="#database-transactions" id="id43">Database transactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example" id="id44">Example</a><ul>
<li><a class="reference internal" href="#blog-models-py" id="id45">blog/models.py</a></li>
<li><a class="reference internal" href="#blog-views-py" id="id46">blog/views.py</a></li>
<li><a class="reference internal" href="#blog-tasks-py" id="id47">blog/tasks.py</a></li>
</ul>
</li>
</ul>
</div>
<p>This guide gives an overview of how tasks are defined. For a complete
listing of task attributes and methods, please see the
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask" title="celery.task.base.BaseTask"><tt class="xref py py-class docutils literal"><span class="pre">API</span> <span class="pre">reference</span></tt></a>.</p>
<div class="section" id="basics">
<span id="task-basics"></span><h2><a class="toc-backref" href="#id5">Basics</a><a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>A task is a class that encapsulates a function and its execution options.
Given a function create_user`, that takes two arguments: <cite>username</cite> and
<cite>password</cite>, you can create a task like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">User</span>

<span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>Task options are added as arguments to <cite>task</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">&quot;json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="context">
<span id="task-request-info"></span><h2><a class="toc-backref" href="#id6">Context</a><a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p><cite>task.request</cite> contains information and state related
the currently executing task, and must always contain the following
attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">id:</th><td class="field-body"><p class="first">The unique id of the executing task.</p>
</td>
</tr>
<tr class="field"><th class="field-name">taskset:</th><td class="field-body"><p class="first">The unique id of the taskset this task is a member of (if any).</p>
</td>
</tr>
<tr class="field"><th class="field-name">args:</th><td class="field-body"><p class="first">Positional arguments.</p>
</td>
</tr>
<tr class="field"><th class="field-name">kwargs:</th><td class="field-body"><p class="first">Keyword arguments.</p>
</td>
</tr>
<tr class="field"><th class="field-name">retries:</th><td class="field-body"><p class="first">How many times the current task has been retried.
An integer starting at <cite>0</cite>.</p>
</td>
</tr>
<tr class="field"><th class="field-name">is_eager:</th><td class="field-body"><p class="first">Set to <tt class="xref py py-const xref docutils literal"><span class="pre">True</span></tt> if the task is executed locally in
the client, and not by a worker.</p>
</td>
</tr>
<tr class="field"><th class="field-name">logfile:</th><td class="field-body"><p class="first">The file the worker logs to.  See <a class="reference internal" href="#logging">Logging</a>.</p>
</td>
</tr>
<tr class="field"><th class="field-name">loglevel:</th><td class="field-body"><p class="first">The current log level used.</p>
</td>
</tr>
<tr class="field"><th class="field-name">delivery_info:</th><td class="field-body"><dl class="first docutils">
<dt>Additional message delivery information. This is a mapping</dt>
<dd><p class="first last">containing the exchange and routing key used to deliver this
task.  Used by e.g. <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask.retry" title="celery.task.base.BaseTask.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a>
to resend the task to the same destination queue.</p>
</dd>
</dl>
<p class="last"><strong>NOTE</strong> As some messaging backends doesn&#8217;t have advanced routing
capabilities, you can&#8217;t trust the availability of keys in this mapping.</p>
</td>
</tr>
</tbody>
</table>
<div class="section" id="example-usage">
<h3><a class="toc-backref" href="#id7">Example Usage</a><a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Executing task id </span><span class="si">%r</span><span class="s">, args: </span><span class="si">%r</span><span class="s"> kwargs: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">add</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">add</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">add</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="logging">
<span id="task-logging"></span><h2><a class="toc-backref" href="#id8">Logging</a><a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>You can use the workers logger to add diagnostic output to
the worker log:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>There are several logging levels available, and the workers <cite>loglevel</cite>
setting decides whether or not they will be written to the log file.</p>
<p>Of course, you can also simply use <cite>print</cite> as anything written to standard
out/-err will be written to the log file as well.</p>
</div>
<div class="section" id="retrying-a-task-if-something-fails">
<span id="task-retry"></span><h2><a class="toc-backref" href="#id9">Retrying a task if something fails</a><a class="headerlink" href="#retrying-a-task-if-something-fails" title="Permalink to this headline">¶</a></h2>
<p>Simply use <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask.retry" title="celery.task.base.BaseTask.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a> to re-send the task.
It will do the right thing, and respect the
<tt class="xref py py-attr docutils literal"><span class="pre">max_retries</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">),</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">send_twitter_status</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we used the <cite>exc</cite> argument to pass the current exception to
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask.retry" title="celery.task.base.BaseTask.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a>. At each step of the retry this exception
is available as the tombstone (result) of the task. When
<tt class="xref py py-attr docutils literal"><span class="pre">max_retries</span></tt> has been exceeded this is the
exception raised.  However, if an <cite>exc</cite> argument is not provided the
<a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.RetryTaskError" title="celery.exceptions.RetryTaskError"><tt class="xref py py-exc docutils literal"><span class="pre">RetryTaskError</span></tt></a> exception is raised instead.</p>
<div class="section" id="using-a-custom-retry-delay">
<span id="task-retry-custom-delay"></span><h3><a class="toc-backref" href="#id10">Using a custom retry delay</a><a class="headerlink" href="#using-a-custom-retry-delay" title="Permalink to this headline">¶</a></h3>
<p>When a task is to be retried, it will wait for a given amount of time
before doing so. The default delay is in the
<tt class="xref py py-attr docutils literal"><span class="pre">default_retry_delay</span></tt>
attribute on the task. By default this is set to 3 minutes. Note that the
unit for setting the delay is in seconds (int or float).</p>
<p>You can also provide the <cite>countdown</cite> argument to
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask.retry" title="celery.task.base.BaseTask.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a> to override this default.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c"># retry in 30 minutes.</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">add</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c"># override the default and</span>
                                          <span class="c"># retry in 1 minute</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="task-options">
<span id="id1"></span><h2><a class="toc-backref" href="#id11">Task options</a><a class="headerlink" href="#task-options" title="Permalink to this headline">¶</a></h2>
<div class="section" id="general">
<h3><a class="toc-backref" href="#id12">General</a><a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h3>
<span class="target" id="task-general-options"></span><dl class="attribute">
<dt id="Task.name">
<tt class="descclassname">Task.</tt><tt class="descname">name</tt><a class="headerlink" href="#Task.name" title="Permalink to this definition">¶</a></dt>
<dd><p>The name the task is registered as.</p>
<p>You can set this name manually, or just use the default which is
automatically generated using the module and class name.  See
<a class="reference internal" href="#task-names"><em>Task names</em></a>.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.abstract">
<tt class="descclassname">Task.</tt><tt class="descname">abstract</tt><a class="headerlink" href="#Task.abstract" title="Permalink to this definition">¶</a></dt>
<dd><p>Abstract classes are not registered, but are used as the
base class for new task types.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.max_retries">
<tt class="descclassname">Task.</tt><tt class="descname">max_retries</tt><a class="headerlink" href="#Task.max_retries" title="Permalink to this definition">¶</a></dt>
<dd><p>The maximum number of attempted retries before giving up.
If this exceeds the <tt class="xref py py-exc docutils literal"><span class="pre">MaxRetriesExceeded</span></tt>
an exception will be raised.  <em>NOTE:</em> You have to <tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt>
manually, it&#8217;s not something that happens automatically.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.default_retry_delay">
<tt class="descclassname">Task.</tt><tt class="descname">default_retry_delay</tt><a class="headerlink" href="#Task.default_retry_delay" title="Permalink to this definition">¶</a></dt>
<dd><p>Default time in seconds before a retry of the task
should be executed.  Can be either <tt class="xref py py-class docutils literal"><span class="pre">int</span></tt> or <tt class="xref py py-class docutils literal"><span class="pre">float</span></tt>.
Default is a 3 minute delay.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.rate_limit">
<tt class="descclassname">Task.</tt><tt class="descname">rate_limit</tt><a class="headerlink" href="#Task.rate_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the rate limit for this task type, i.e. how many times in
a given period of time is the task allowed to run.</p>
<p>If this is <tt class="xref py py-const xref docutils literal"><span class="pre">None</span></tt> no rate limit is in effect.
If it is an integer, it is interpreted as &#8220;tasks per second&#8221;.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <cite>&#8220;/s&#8221;</cite>, <cite>&#8220;/m&#8221;</cite> or <cite>&#8220;/h&#8221;</cite> to the value.
Example: <cite>&#8220;100/m&#8221;</cite> (hundred tasks a minute).  Default is the
<a class="reference internal" href="../configuration.html#std:setting-CELERY_DEFAULT_RATE_LIMIT"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_DEFAULT_RATE_LIMIT</span></tt></a> setting, which if not specified means
rate limiting for tasks is disabled by default.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.time_limit">
<tt class="descclassname">Task.</tt><tt class="descname">time_limit</tt><a class="headerlink" href="#Task.time_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>The hard time limit for this task.  If not set then the workers default
will be used.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.soft_time_limit">
<tt class="descclassname">Task.</tt><tt class="descname">soft_time_limit</tt><a class="headerlink" href="#Task.soft_time_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>The soft time limit for this task.  If not set then the workers default
will be used.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.ignore_result">
<tt class="descclassname">Task.</tt><tt class="descname">ignore_result</tt><a class="headerlink" href="#Task.ignore_result" title="Permalink to this definition">¶</a></dt>
<dd><p>Don&#8217;t store task state.    Note that this means you can&#8217;t use
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><tt class="xref py py-class docutils literal"><span class="pre">AsyncResult</span></tt></a> to check if the task is ready,
or get its return value.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.store_errors_even_if_ignored">
<tt class="descclassname">Task.</tt><tt class="descname">store_errors_even_if_ignored</tt><a class="headerlink" href="#Task.store_errors_even_if_ignored" title="Permalink to this definition">¶</a></dt>
<dd><p>If <tt class="xref py py-const xref docutils literal"><span class="pre">True</span></tt>, errors will be stored even if the task is configured
to ignore results.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.send_error_emails">
<tt class="descclassname">Task.</tt><tt class="descname">send_error_emails</tt><a class="headerlink" href="#Task.send_error_emails" title="Permalink to this definition">¶</a></dt>
<dd><p>Send an email whenever a task of this type fails.
Defaults to the <a class="reference internal" href="../configuration.html#std:setting-CELERY_SEND_TASK_ERROR_EMAILS"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_SEND_TASK_ERROR_EMAILS</span></tt></a> setting.
See <a class="reference internal" href="../configuration.html#conf-error-mails"><em>Error E-Mails</em></a> for more information.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.error_whitelist">
<tt class="descclassname">Task.</tt><tt class="descname">error_whitelist</tt><a class="headerlink" href="#Task.error_whitelist" title="Permalink to this definition">¶</a></dt>
<dd><p>If the sending of error emails is enabled for this task, then
this is a white list of exceptions to actually send emails about.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.serializer">
<tt class="descclassname">Task.</tt><tt class="descname">serializer</tt><a class="headerlink" href="#Task.serializer" title="Permalink to this definition">¶</a></dt>
<dd><p>A string identifying the default serialization
method to use. Defaults to the <a class="reference internal" href="../configuration.html#std:setting-CELERY_TASK_SERIALIZER"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_TASK_SERIALIZER</span></tt></a>
setting.  Can be <cite>pickle</cite> <cite>json</cite>, <cite>yaml</cite>, or any custom
serialization methods that have been registered with
<tt class="xref py py-mod docutils literal"><span class="pre">kombu.serialization.registry</span></tt>.</p>
<p>Please see <a class="reference internal" href="executing.html#executing-serializers"><em>Serializers</em></a> for more information.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.backend">
<tt class="descclassname">Task.</tt><tt class="descname">backend</tt><a class="headerlink" href="#Task.backend" title="Permalink to this definition">¶</a></dt>
<dd><p>The result store backend to use for this task.  Defaults to the
<a class="reference internal" href="../configuration.html#std:setting-CELERY_RESULT_BACKEND"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_RESULT_BACKEND</span></tt></a> setting.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.acks_late">
<tt class="descclassname">Task.</tt><tt class="descname">acks_late</tt><a class="headerlink" href="#Task.acks_late" title="Permalink to this definition">¶</a></dt>
<dd><p>If set to <tt class="xref py py-const xref docutils literal"><span class="pre">True</span></tt> messages for this task will be acknowledged
<strong>after</strong> the task has been executed, not <em>just before</em>, which is
the default behavior.</p>
<p>Note that this means the task may be executed twice if the worker
crashes in the middle of execution, which may be acceptable for some
applications.</p>
<p>The global default can be overridden by the <a class="reference internal" href="../configuration.html#std:setting-CELERY_ACKS_LATE"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_ACKS_LATE</span></tt></a>
setting.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.track_started">
<tt class="descclassname">Task.</tt><tt class="descname">track_started</tt><a class="headerlink" href="#Task.track_started" title="Permalink to this definition">¶</a></dt>
<dd><p>If <tt class="xref py py-const xref docutils literal"><span class="pre">True</span></tt> the task will report its status as &#8220;started&#8221;
when the task is executed by a worker.
The default value is <tt class="xref py py-const xref docutils literal"><span class="pre">False</span></tt> as the normal behaviour is to not
report that level of granularity. Tasks are either pending, finished,
or waiting to be retried.  Having a &#8220;started&#8221; status can be useful for
when there are long running tasks and there is a need to report which
task is currently running.</p>
<p>The host name and process id of the worker executing the task
will be available in the state metadata (e.g. <cite>result.info[&#8220;pid&#8221;]</cite>)</p>
<p>The global default can be overridden by the
<a class="reference internal" href="../configuration.html#std:setting-CELERY_TRACK_STARTED"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_TRACK_STARTED</span></tt></a> setting.</p>
</dd></dl>

<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The API reference for <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask" title="celery.task.base.BaseTask"><tt class="xref py py-class docutils literal"><span class="pre">BaseTask</span></tt></a>.</p>
</div>
</div>
<div class="section" id="message-and-routing-options">
<span id="task-message-options"></span><h3><a class="toc-backref" href="#id13">Message and routing options</a><a class="headerlink" href="#message-and-routing-options" title="Permalink to this headline">¶</a></h3>
<dl class="attribute">
<dt id="Task.queue">
<tt class="descclassname">Task.</tt><tt class="descname">queue</tt><a class="headerlink" href="#Task.queue" title="Permalink to this definition">¶</a></dt>
<dd><p>Use the routing settings from a queue defined in <a class="reference internal" href="../configuration.html#std:setting-CELERY_QUEUES"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_QUEUES</span></tt></a>.
If defined the <a class="reference internal" href="#Task.exchange" title="Task.exchange"><tt class="xref py py-attr docutils literal"><span class="pre">exchange</span></tt></a> and <a class="reference internal" href="#Task.routing_key" title="Task.routing_key"><tt class="xref py py-attr docutils literal"><span class="pre">routing_key</span></tt></a> options will be
ignored.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.exchange">
<tt class="descclassname">Task.</tt><tt class="descname">exchange</tt><a class="headerlink" href="#Task.exchange" title="Permalink to this definition">¶</a></dt>
<dd><p>Override the global default <cite>exchange</cite> for this task.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.routing_key">
<tt class="descclassname">Task.</tt><tt class="descname">routing_key</tt><a class="headerlink" href="#Task.routing_key" title="Permalink to this definition">¶</a></dt>
<dd><p>Override the global default <cite>routing_key</cite> for this task.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.mandatory">
<tt class="descclassname">Task.</tt><tt class="descname">mandatory</tt><a class="headerlink" href="#Task.mandatory" title="Permalink to this definition">¶</a></dt>
<dd><p>If set, the task message has mandatory routing.  By default the task
is silently dropped by the broker if it can&#8217;t be routed to a queue.
However &#8211; If the task is mandatory, an exception will be raised
instead.</p>
<p>Not supported by amqplib.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.immediate">
<tt class="descclassname">Task.</tt><tt class="descname">immediate</tt><a class="headerlink" href="#Task.immediate" title="Permalink to this definition">¶</a></dt>
<dd><p>Request immediate delivery.  If the task cannot be routed to a
task worker immediately, an exception will be raised.  This is
instead of the default behavior, where the broker will accept and
queue the task, but with no guarantee that the task will ever
be executed.</p>
<p>Not supported by amqplib.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.priority">
<tt class="descclassname">Task.</tt><tt class="descname">priority</tt><a class="headerlink" href="#Task.priority" title="Permalink to this definition">¶</a></dt>
<dd><p>The message priority. A number from 0 to 9, where 0 is the
highest priority.</p>
<p>Not supported by RabbitMQ.</p>
</dd></dl>

<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="executing.html#executing-routing"><em>Routing options</em></a> for more information about message options,
and <a class="reference internal" href="routing.html#guide-routing"><em>Routing Tasks</em></a>.</p>
</div>
</div>
</div>
<div class="section" id="task-names">
<span id="id2"></span><h2><a class="toc-backref" href="#id14">Task names</a><a class="headerlink" href="#task-names" title="Permalink to this headline">¶</a></h2>
<p>The task type is identified by the <em>task name</em>.</p>
<p>If not provided a name will be automatically generated using the module
and class name.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;sum-of-two-numbers&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;sum-of-two-numbers&#39;</span>
</pre></div>
</div>
<p>The best practice is to use the module name as a prefix to classify the
tasks using namespaces.  This way the name won&#8217;t collide with the name from
another module:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;tasks.add&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p>Which is exactly the name that is automatically generated for this
task if the module name is &#8220;tasks.py&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nd">@task</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<div class="section" id="automatic-naming-and-relative-imports">
<span id="task-naming-relative-imports"></span><h3><a class="toc-backref" href="#id15">Automatic naming and relative imports</a><a class="headerlink" href="#automatic-naming-and-relative-imports" title="Permalink to this headline">¶</a></h3>
<p>Relative imports and automatic name generation does not go well together,
so if you&#8217;re using relative imports you should set the name explicitly.</p>
<p>For example if the client imports the module &#8220;myapp.tasks&#8221; as &#8221;.tasks&#8221;, and
the worker imports the module as &#8220;myapp.tasks&#8221;, the generated names won&#8217;t match
and an <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.NotRegistered" title="celery.exceptions.NotRegistered"><tt class="xref py py-exc docutils literal"><span class="pre">NotRegistered</span></tt></a> error will be raised by the worker.</p>
<p>This is also the case if using Django and using <cite>project.myapp</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;project.myapp&quot;</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
<p>The worker will have the tasks registered as &#8220;project.myapp.tasks.*&#8221;,
while this is what happens in the client if the module is imported as
&#8220;myapp.tasks&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;myapp.tasks.add&#39;</span>
</pre></div>
</div>
<p>For this reason you should never use &#8220;project.app&#8221;, but rather
add the project directory to the Python path:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;myapp&quot;</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
<p>This makes more sense from the reusable app perspective anyway.</p>
</div>
</div>
<div class="section" id="decorating-tasks">
<span id="tasks-decorating"></span><h2><a class="toc-backref" href="#id16">Decorating tasks</a><a class="headerlink" href="#decorating-tasks" title="Permalink to this headline">¶</a></h2>
<p>When using other decorators you must make sure that the <cite>task</cite>
decorator is applied last:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="nd">@decorator2</span>
<span class="nd">@decorator1</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>Which means the <cite>&#64;task</cite> decorator must be the top statement.</p>
</div>
<div class="section" id="task-states">
<span id="id3"></span><h2><a class="toc-backref" href="#id17">Task States</a><a class="headerlink" href="#task-states" title="Permalink to this headline">¶</a></h2>
<p>Celery can keep track of the tasks current state.  The state also contains the
result of a successful task, or the exception and traceback information of a
failed task.</p>
<p>There are several <em>result backends</em> to choose from, and they all have
different strenghts and weaknesses (see <a class="reference internal" href="#task-result-backends"><em>Result Backends</em></a>).</p>
<p>During its lifetime a task will transition through several possible states,
and each state may have arbitrary metadata attached to it.  When a task
moves into a new state the previous state is
forgotten about, but some transitions can be deducted, (e.g. a task now
in the <tt class="xref std std-state docutils literal"><span class="pre">FAILED</span></tt> state, is implied to have been in the
<a class="reference internal" href="#std:state-STARTED"><tt class="xref std std-state docutils literal"><span class="pre">STARTED</span></tt></a> state at some point).</p>
<p>There are also sets of states, like the set of
<tt class="xref std std-state docutils literal"><span class="pre">failure</span> <span class="pre">states</span></tt>, and the set of
<a class="reference internal" href="../reference/celery.states.html#std:state-READY_STATES"><tt class="xref std std-state docutils literal"><span class="pre">ready</span> <span class="pre">states</span></tt></a>.</p>
<p>The client uses the membership of these sets to decide whether
the exception should be re-raised (<a class="reference internal" href="../reference/celery.states.html#std:state-PROPAGATE_STATES"><tt class="xref std std-state docutils literal"><span class="pre">PROPAGATE_STATES</span></tt></a>), or whether
the result can be cached (it can if the task is ready).</p>
<p>You can also define <a class="reference internal" href="#custom-states"><em>Custom states</em></a>.</p>
<div class="section" id="result-backends">
<span id="task-result-backends"></span><h3><a class="toc-backref" href="#id18">Result Backends</a><a class="headerlink" href="#result-backends" title="Permalink to this headline">¶</a></h3>
<p>Celery needs to store or send the states somewhere.  There are several
built-in backends to choose from: SQLAlchemy/Django ORM, Memcached, Redis,
AMQP, MongoDB, Tokyo Tyrant and Redis &#8211; or you can define your own.</p>
<p>No backend works well for every use case.
You should read about the strenghts and weaknesses of each backend, and choose
the most appropriate for your needs.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../configuration.html#conf-result-backend"><em>Task result backend settings</em></a></p>
</div>
<div class="section" id="amqp-result-backend">
<h4><a class="toc-backref" href="#id19">AMQP Result Backend</a><a class="headerlink" href="#amqp-result-backend" title="Permalink to this headline">¶</a></h4>
<p>The AMQP result backend is special as it does not actually <em>store</em> the states,
but rather sends them as messages.  This is an important difference as it
means that a result <em>can only be retrieved once</em>; If you have two processes
waiting for the same result, one of the processes will never receive the
result!</p>
<p>Even with that limitation, it is an excellent choice if you need to receive
state changes in real-time.  Using messaging means the client does not have to
poll for new states.</p>
<p>There are several other pitfalls you should be aware of when using the AMQP
backend:</p>
<ul class="simple">
<li>Every new task creates a new queue on the server, with thousands of tasks
the broker may be overloaded with queues and this will affect performance in
negative ways. If you&#8217;re using RabbitMQ then each queue will be a separate
Erlang process, so if you&#8217;re planning to keep many results simultaneously you
may have to increase the Erlang process limit, and the maximum number of file
descriptors your OS allows.</li>
<li>Old results will not be cleaned automatically, so you must make sure to
consume the results or else the number of queues will eventually go out of
control.  If you&#8217;re running RabbitMQ 2.1.1 or higher you can take advantage
of the <tt class="docutils literal"><span class="pre">x-expires</span></tt> argument to queues, which will expire queues after a
certain time limit after they are unused.  The queue expiry can be set (in
seconds) by the <a class="reference internal" href="../configuration.html#std:setting-CELERY_AMQP_TASK_RESULT_EXPIRES"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_AMQP_TASK_RESULT_EXPIRES</span></tt></a> setting (not
enabled by default).</li>
</ul>
<p>For a list of options supported by the AMQP result backend, please see
<a class="reference internal" href="../configuration.html#conf-amqp-result-backend"><em>AMQP backend settings</em></a>.</p>
</div>
<div class="section" id="database-result-backend">
<h4><a class="toc-backref" href="#id20">Database Result Backend</a><a class="headerlink" href="#database-result-backend" title="Permalink to this headline">¶</a></h4>
<p>Keeping state in the database can be convenient for many, especially for
web applications with a database already in place, but it also comes with
limitations.</p>
<ul>
<li><p class="first">Polling the database for new states is expensive, and so you should
increase the polling intervals of operations such as <cite>result.wait()</cite>, and
<cite>tasksetresult.join()</cite></p>
</li>
<li><p class="first">Some databases uses a default transaction isolation level that
is not suitable for polling tables for changes.</p>
<p>In MySQL the default transaction isolation level is <cite>REPEATABLE-READ</cite>, which
means the transaction will not see changes by other transactions until the
transaction is commited.  It is recommended that you change to the
<cite>READ-COMMITTED</cite> isolation level.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="built-in-states">
<span id="task-builtin-states"></span><h3><a class="toc-backref" href="#id21">Built-in States</a><a class="headerlink" href="#built-in-states" title="Permalink to this headline">¶</a></h3>
<div class="section" id="pending">
<span id="std:state-PENDING"></span><h4><a class="toc-backref" href="#id22">PENDING</a><a class="headerlink" href="#pending" title="Permalink to this headline">¶</a></h4>
<p>Task is waiting for execution or unknown.
Any task id that is not know is implied to be in the pending state.</p>
</div>
<div class="section" id="started">
<span id="std:state-STARTED"></span><h4><a class="toc-backref" href="#id23">STARTED</a><a class="headerlink" href="#started" title="Permalink to this headline">¶</a></h4>
<p>Task has been started.
Not reported by default, to enable please see :attr`Task.track_started`.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">metadata:</th><td class="field-body"><cite>pid</cite> and <cite>hostname</cite> of the worker process executing
the task.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="success">
<span id="std:state-SUCCESS"></span><h4><a class="toc-backref" href="#id24">SUCCESS</a><a class="headerlink" href="#success" title="Permalink to this headline">¶</a></h4>
<p>Task has been successfully executed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">metadata:</th><td class="field-body"><cite>result</cite> contains the return value of the task.</td>
</tr>
<tr class="field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
<tr class="field"><th class="field-name">ready:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="failure">
<span id="std:state-FAILURE"></span><h4><a class="toc-backref" href="#id25">FAILURE</a><a class="headerlink" href="#failure" title="Permalink to this headline">¶</a></h4>
<p>Task execution resulted in failure.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">metadata:</th><td class="field-body"><cite>result</cite> contains the exception occurred, and <cite>traceback</cite>
contains the backtrace of the stack at the point when the
exception was raised.</td>
</tr>
<tr class="field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="retry">
<span id="std:state-RETRY"></span><h4><a class="toc-backref" href="#id26">RETRY</a><a class="headerlink" href="#retry" title="Permalink to this headline">¶</a></h4>
<p>Task is being retried.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">metadata:</th><td class="field-body"><cite>result</cite> contains the exception that caused the retry,
and <cite>traceback</cite> contains the backtrace of the stack at the point
when the exceptions was raised.</td>
</tr>
<tr class="field"><th class="field-name">propagates:</th><td class="field-body">No</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="revoked">
<span id="std:state-REVOKED"></span><h4><a class="toc-backref" href="#id27">REVOKED</a><a class="headerlink" href="#revoked" title="Permalink to this headline">¶</a></h4>
<p>Task has been revoked.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="custom-states">
<span id="id4"></span><h3><a class="toc-backref" href="#id28">Custom states</a><a class="headerlink" href="#custom-states" title="Permalink to this headline">¶</a></h3>
<p>You can easily define your own states, all you need is a unique name.
The name of the state is usually an uppercase string.  As an example
you could have a look at <tt class="xref py py-mod docutils literal"><span class="pre">abortable</span> <span class="pre">tasks</span></tt>
which defines its own custom <tt class="xref std std-state docutils literal"><span class="pre">ABORTED</span></tt> state.</p>
<p>Use <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask.update_state" title="celery.task.base.BaseTask.update_state"><tt class="xref py py-meth docutils literal"><span class="pre">Task.update_state</span></tt></a> to
update a tasks state:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">upload_files</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="n">upload_files</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&quot;PROGRESS&quot;</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;current&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)})</span>
</pre></div>
</div>
<p>Here we created the state <cite>&#8220;PROGRESS&#8221;</cite>, which tells any application
aware of this state that the task is currently in progress, and also where
it is in the process by having <cite>current</cite> and <cite>total</cite> counts as part of the
state metadata.  This can then be used to create e.g. progress bars.</p>
</div>
</div>
<div class="section" id="creating-custom-task-classes">
<span id="task-custom-classes"></span><h2><a class="toc-backref" href="#id29">Creating custom task classes</a><a class="headerlink" href="#creating-custom-task-classes" title="Permalink to this headline">¶</a></h2>
<p>All tasks inherit from the <a class="reference internal" href="../reference/celery.task.html#celery.task.Task" title="celery.task.Task"><tt class="xref py py-class docutils literal"><span class="pre">celery.task.Task</span></tt></a> class.
The tasks body is its <tt class="xref py py-meth docutils literal"><span class="pre">run()</span></tt> method.</p>
<p>The following code,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>will do roughly this behind the scenes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">AddTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">AddTask</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="instantiation">
<h3><a class="toc-backref" href="#id30">Instantiation</a><a class="headerlink" href="#instantiation" title="Permalink to this headline">¶</a></h3>
<p>A task is <strong>not</strong> instantiated for every request, but is registered
in the task registry as a global instance.</p>
<p>This means that the <tt class="docutils literal"><span class="pre">__init__</span></tt> constructor will only be called
once per process, and that the task class is semantically closer to an
Actor.</p>
<p>If you have a task,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NaiveAuthenticateServer</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;george&quot;</span><span class="p">:</span> <span class="s">&quot;password&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
<p>And you route every request to the same process, then it
will keep state between requests.</p>
<p>This can also be useful to keep cached resources:</p>
<div class="highlight-python"><pre>class DatabaseTask(Task):
    _db = None

    @property
    def db(self):
        if self._db = None:
            self._db = Database.connect()
        return self._db</pre>
</div>
</div>
<div class="section" id="abstract-classes">
<h3><a class="toc-backref" href="#id31">Abstract classes</a><a class="headerlink" href="#abstract-classes" title="Permalink to this headline">¶</a></h3>
<p>Abstract classes are not registered, but are used as the
base class for new task types.</p>
<div class="highlight-python"><pre>class DebugTask(object):
    abstract = True

    def after_return(self, \*args, \*\*kwargs):
        print("Task returned: %r" % (self.request, ))


@task(base=DebugTask)
def add(x, y):
    return x + y</pre>
</div>
</div>
<div class="section" id="handlers">
<h3><a class="toc-backref" href="#id32">Handlers</a><a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt>
<tt class="descname">execute(self, request, pool, loglevel, logfile, **kw):</tt></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>request</strong> &#8211; A <a class="reference internal" href="../internals/reference/celery.worker.job.html#celery.worker.job.TaskRequest" title="celery.worker.job.TaskRequest"><tt class="xref py py-class docutils literal"><span class="pre">TaskRequest</span></tt></a>.</li>
<li><strong>pool</strong> &#8211; The task pool.</li>
<li><strong>loglevel</strong> &#8211; Current loglevel.</li>
<li><strong>logfile</strong> &#8211; Name of the currently used logfile.</li>
<li><strong>consumer</strong> &#8211; The <a class="reference internal" href="../internals/reference/celery.worker.consumer.html#celery.worker.consumer.Consumer" title="celery.worker.consumer.Consumer"><tt class="xref py py-class docutils literal"><span class="pre">Consumer</span></tt></a>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="after_return">
<tt class="descname">after_return</tt><big>(</big><em>self</em>, <em>status</em>, <em>retval</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><big>)</big><a class="headerlink" href="#after_return" title="Permalink to this definition">¶</a></dt>
<dd><p>Handler called after the task returns.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>status</strong> &#8211; Current task state.</li>
<li><strong>retval</strong> &#8211; Task return value/exception.</li>
<li><strong>task_id</strong> &#8211; Unique id of the task.</li>
<li><strong>args</strong> &#8211; Original arguments for the task that failed.</li>
<li><strong>kwargs</strong> &#8211; Original keyword arguments for the task
that failed.</li>
<li><strong>einfo</strong> &#8211; <a class="reference internal" href="../internals/reference/celery.datastructures.html#celery.datastructures.ExceptionInfo" title="celery.datastructures.ExceptionInfo"><tt class="xref py py-class docutils literal"><span class="pre">ExceptionInfo</span></tt></a>
instance, containing the traceback (if any).</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_failure">
<tt class="descname">on_failure</tt><big>(</big><em>self</em>, <em>exc</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><big>)</big><a class="headerlink" href="#on_failure" title="Permalink to this definition">¶</a></dt>
<dd><p>This is run by the worker when the task fails.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>exc</strong> &#8211; The exception raised by the task.</li>
<li><strong>task_id</strong> &#8211; Unique id of the failed task.</li>
<li><strong>args</strong> &#8211; Original arguments for the task that failed.</li>
<li><strong>kwargs</strong> &#8211; Original keyword arguments for the task
that failed.</li>
<li><strong>einfo</strong> &#8211; <a class="reference internal" href="../internals/reference/celery.datastructures.html#celery.datastructures.ExceptionInfo" title="celery.datastructures.ExceptionInfo"><tt class="xref py py-class docutils literal"><span class="pre">ExceptionInfo</span></tt></a>
instance, containing the traceback.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_retry">
<tt class="descname">on_retry</tt><big>(</big><em>self</em>, <em>exc</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><big>)</big><a class="headerlink" href="#on_retry" title="Permalink to this definition">¶</a></dt>
<dd><p>This is run by the worker when the task is to be retried.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>exc</strong> &#8211; The exception sent to <tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt>.</li>
<li><strong>task_id</strong> &#8211; Unique id of the retried task.</li>
<li><strong>args</strong> &#8211; Original arguments for the retried task.</li>
<li><strong>kwargs</strong> &#8211; Original keyword arguments for the retried task.</li>
<li><strong>einfo</strong> &#8211; <a class="reference internal" href="../internals/reference/celery.datastructures.html#celery.datastructures.ExceptionInfo" title="celery.datastructures.ExceptionInfo"><tt class="xref py py-class docutils literal"><span class="pre">ExceptionInfo</span></tt></a>
instance, containing the traceback.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_success">
<tt class="descname">on_success</tt><big>(</big><em>self</em>, <em>retval</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em><big>)</big><a class="headerlink" href="#on_success" title="Permalink to this definition">¶</a></dt>
<dd><p>Run by the worker if the task executes successfully.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>retval</strong> &#8211; The return value of the task.</li>
<li><strong>task_id</strong> &#8211; Unique id of the executed task.</li>
<li><strong>args</strong> &#8211; Original arguments for the executed task.</li>
<li><strong>kwargs</strong> &#8211; Original keyword arguments for the executed task.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<div class="section" id="on-retry">
<h4><a class="toc-backref" href="#id33">on_retry</a><a class="headerlink" href="#on-retry" title="Permalink to this headline">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="how-it-works">
<span id="task-how-they-work"></span><h2><a class="toc-backref" href="#id34">How it works</a><a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>Here comes the technical details, this part isn&#8217;t something you need to know,
but you may be interested.</p>
<p>All defined tasks are listed in a registry.  The registry contains
a list of task names and their task classes.  You can investigate this registry
yourself:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">task</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">registry</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.delete_expired_task_meta&#39;:</span>
<span class="go">    &lt;PeriodicTask: celery.delete_expired_task_meta (periodic)&gt;,</span>
<span class="go"> &#39;celery.task.http.HttpDispatchTask&#39;:</span>
<span class="go">    &lt;Task: celery.task.http.HttpDispatchTask (regular)&gt;,</span>
<span class="go"> &#39;celery.execute_remote&#39;:</span>
<span class="go">    &lt;Task: celery.execute_remote (regular)&gt;,</span>
<span class="go"> &#39;celery.map_async&#39;:</span>
<span class="go">    &lt;Task: celery.map_async (regular)&gt;,</span>
<span class="go"> &#39;celery.ping&#39;:</span>
<span class="go">    &lt;Task: celery.ping (regular)&gt;}</span>
</pre></div>
</div>
<p>This is the list of tasks built-in to celery.  Note that we had to import
<cite>celery.task</cite> first for these to show up.  This is because the tasks will
only be registered when the module they are defined in is imported.</p>
<p>The default loader imports any modules listed in the
<a class="reference internal" href="../configuration.html#std:setting-CELERY_IMPORTS"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_IMPORTS</span></tt></a> setting.</p>
<p>The entity responsible for registering your task in the registry is a
meta class, <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.TaskType" title="celery.task.base.TaskType"><tt class="xref py py-class docutils literal"><span class="pre">TaskType</span></tt></a>.  This is the default
meta class for <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.BaseTask" title="celery.task.base.BaseTask"><tt class="xref py py-class docutils literal"><span class="pre">BaseTask</span></tt></a>.</p>
<p>If you want to register your task manually you can mark the
task as <tt class="xref py py-attr docutils literal"><span class="pre">abstract</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>This way the task won&#8217;t be registered, but any task inheriting from
it will be.</p>
<p>When tasks are sent, we don&#8217;t send any actual function code, just the name
of the task to execute.  When the worker then receives the message it can look
up the name in its task registry to find the execution code.</p>
<p>This means that your workers should always be updated with the same software
as the client.  This is a drawback, but the alternative is a technical
challenge that has yet to be solved.</p>
</div>
<div class="section" id="tips-and-best-practices">
<span id="task-best-practices"></span><h2><a class="toc-backref" href="#id35">Tips and Best Practices</a><a class="headerlink" href="#tips-and-best-practices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ignore-results-you-don-t-want">
<span id="task-ignore-results"></span><h3><a class="toc-backref" href="#id36">Ignore results you don&#8217;t want</a><a class="headerlink" href="#ignore-results-you-don-t-want" title="Permalink to this headline">¶</a></h3>
<p>If you don&#8217;t care about the results of a task, be sure to set the
<tt class="xref py py-attr docutils literal"><span class="pre">ignore_result</span></tt> option, as storing results
wastes time and resources.</p>
<div class="highlight-python"><pre>@task(ignore_result=True)
def mytask(...)
    something()</pre>
</div>
<p>Results can even be disabled globally using the <a class="reference internal" href="../configuration.html#std:setting-CELERY_IGNORE_RESULT"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_IGNORE_RESULT</span></tt></a>
setting.</p>
</div>
<div class="section" id="disable-rate-limits-if-they-re-not-used">
<span id="task-disable-rate-limits"></span><h3><a class="toc-backref" href="#id37">Disable rate limits if they&#8217;re not used</a><a class="headerlink" href="#disable-rate-limits-if-they-re-not-used" title="Permalink to this headline">¶</a></h3>
<p>Disabling rate limits altogether is recommended if you don&#8217;t have
any tasks using them.  This is because the rate limit subsystem introduces
quite a lot of complexity.</p>
<p>Set the <a class="reference internal" href="../configuration.html#std:setting-CELERY_DISABLE_RATE_LIMITS"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_DISABLE_RATE_LIMITS</span></tt></a> setting to globally disable
rate limits:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_DISABLE_RATE_LIMITS</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="avoid-launching-synchronous-subtasks">
<span id="task-synchronous-subtasks"></span><h3><a class="toc-backref" href="#id38">Avoid launching synchronous subtasks</a><a class="headerlink" href="#avoid-launching-synchronous-subtasks" title="Permalink to this headline">¶</a></h3>
<p>Having a task wait for the result of another task is really inefficient,
and may even cause a deadlock if the worker pool is exhausted.</p>
<p>Make your design asynchronous instead, for example by using <em>callbacks</em>.</p>
<p><strong>Bad</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Good</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c"># fetch_page -&gt; parse_page -&gt; store_page</span>
    <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">subtask</span><span class="p">(</span><span class="n">parse_page</span><span class="p">,</span>
                                <span class="n">callback</span><span class="o">=</span><span class="n">subtask</span><span class="p">(</span><span class="n">store_page_info</span><span class="p">)))</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="c"># The callback may have been serialized with JSON,</span>
        <span class="c"># so best practice is to convert the subtask dict back</span>
        <span class="c"># into a subtask object.</span>
        <span class="n">subtask</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="n">subtask</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>We use <a class="reference internal" href="../reference/celery.task.sets.html#celery.task.sets.subtask" title="celery.task.sets.subtask"><tt class="xref py py-class docutils literal"><span class="pre">subtask</span></tt></a> here to safely pass
around the callback task.  <a class="reference internal" href="../reference/celery.task.sets.html#celery.task.sets.subtask" title="celery.task.sets.subtask"><tt class="xref py py-class docutils literal"><span class="pre">subtask</span></tt></a> is a
subclass of dict used to wrap the arguments and execution options
for a single task invocation.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="tasksets.html#sets-subtasks"><em>Subtasks</em></a> for more information about subtasks.</p>
</div>
</div>
</div>
<div class="section" id="performance-and-strategies">
<span id="task-performance-and-strategies"></span><h2><a class="toc-backref" href="#id39">Performance and Strategies</a><a class="headerlink" href="#performance-and-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="granularity">
<span id="task-granularity"></span><h3><a class="toc-backref" href="#id40">Granularity</a><a class="headerlink" href="#granularity" title="Permalink to this headline">¶</a></h3>
<p>The task granularity is the amount of computation needed by each subtask.
In general it is better to split the problem up into many small tasks, than
have a few long running tasks.</p>
<p>With smaller tasks you can process more tasks in parallel and the tasks
won&#8217;t run long enough to block the worker from processing other waiting tasks.</p>
<p>However, executing a task does have overhead. A message needs to be sent, data
may not be local, etc. So if the tasks are too fine-grained the additional
overhead may not be worth it in the end.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The book <a class="reference external" href="http://oreilly.com/catalog/9780596521547">Art of Concurrency</a> has a whole section dedicated to the topic
of task granularity.</p>
</div>
</div>
<div class="section" id="data-locality">
<span id="task-data-locality"></span><h3><a class="toc-backref" href="#id41">Data locality</a><a class="headerlink" href="#data-locality" title="Permalink to this headline">¶</a></h3>
<p>The worker processing the task should be as close to the data as
possible.  The best would be to have a copy in memory, the worst would be a
full transfer from another continent.</p>
<p>If the data is far away, you could try to run another worker at location, or
if that&#8217;s not possible - cache often used data, or preload data you know
is going to be used.</p>
<p>The easiest way to share data between workers is to use a distributed cache
system, like <a class="reference external" href="http://memcached.org/">memcached</a>.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The paper <a class="reference external" href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">Distributed Computing Economics</a> by Jim Gray is an excellent
introduction to the topic of data locality.</p>
</div>
</div>
<div class="section" id="state">
<span id="task-state"></span><h3><a class="toc-backref" href="#id42">State</a><a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p>Since celery is a distributed system, you can&#8217;t know in which process, or
on what machine the task will be executed.  You can&#8217;t even know if the task will
run in a timely manner.</p>
<p>The ancient async sayings tells us that “asserting the world is the
responsibility of the task”.  What this means is that the world view may
have changed since the task was requested, so the task is responsible for
making sure the world is how it should be;  If you have a task
that re-indexes a search engine, and the search engine should only be
re-indexed at maximum every 5 minutes, then it must be the tasks
responsibility to assert that, not the callers.</p>
<p>Another gotcha is Django model objects.  They shouldn&#8217;t be passed on as
arguments to tasks.  It&#8217;s almost always better to re-fetch the object from
the database when the task is running instead,  as using old data may lead
to race conditions.</p>
<p>Imagine the following scenario where you have an article and a task
that automatically expands some abbreviations in it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;MyCorp&quot;</span><span class="p">,</span> <span class="s">&quot;My Corporation&quot;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>First, an author creates an article and saves it, then the author
clicks on a button that initiates the abbreviation task.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">model_object</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the queue is very busy, so the task won&#8217;t be run for another 2 minutes.
In the meantime another author makes changes to the article, so
when the task is finally run, the body of the article is reverted to the old
version because the task had the old body in its argument.</p>
<p>Fixing the race condition is easy, just use the article id instead, and
re-fetch the article in the task body:</p>
<div class="highlight-python"><pre>@task
def expand_abbreviations(article_id):
    article = Article.objects.get(id=article_id)
    article.body.replace("MyCorp", "My Corporation")
    article.save()

&gt;&gt;&gt; expand_abbreviations(article_id)</pre>
</div>
<p>There might even be performance benefits to this approach, as sending large
messages may be expensive.</p>
</div>
<div class="section" id="database-transactions">
<span id="task-database-transactions"></span><h3><a class="toc-backref" href="#id43">Database transactions</a><a class="headerlink" href="#database-transactions" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s have a look at another example:</p>
<div class="highlight-python"><pre>from django.db import transaction

@transaction.commit_on_success
def create_article(request):
    article = Article.objects.create(....)
    expand_abbreviations.delay(article.pk)</pre>
</div>
<p>This is a Django view creating an article object in the database,
then passing the primary key to a task.  It uses the <cite>commit_on_success</cite>
decorator, which will commit the transaction when the view returns, or
roll back if the view raises an exception.</p>
<p>There is a race condition if the task starts executing
before the transaction has been committed; The database object does not exist
yet!</p>
<p>The solution is to <em>always commit transactions before sending tasks
depending on state from the current transaction</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@transaction.commit_manually</span>
<span class="k">def</span> <span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example">
<span id="task-example"></span><h2><a class="toc-backref" href="#id44">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s take a real wold example; A blog where comments posted needs to be
filtered for spam.  When the comment is created, the spam filter runs in the
background, so the user doesn&#8217;t have to wait for it to finish.</p>
<p>We have a Django blog application allowing comments
on blog posts.  We&#8217;ll describe parts of the models/views and tasks for this
application.</p>
<div class="section" id="blog-models-py">
<h3><a class="toc-backref" href="#id45">blog/models.py</a><a class="headerlink" href="#blog-models-py" title="Permalink to this headline">¶</a></h3>
<p>The comment model looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;email address&quot;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;home page&quot;</span><span class="p">),</span>
                               <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Published date&quot;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;spam?&quot;</span><span class="p">),</span>
                                  <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the view where the comment is posted, we first write the comment
to the database, then we launch the spam filter task in the background.</p>
</div>
<div class="section" id="blog-views-py">
<span id="task-example-blog-views"></span><h3><a class="toc-backref" href="#id46">blog/views.py</a><a class="headerlink" href="#blog-views-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.template.context</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render_to_response</span>

<span class="kn">from</span> <span class="nn">blog</span> <span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="k">class</span> <span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>


<span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s">&quot;comments/create.html&quot;</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;REMOTE_ADDR&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;post&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c"># Check spam asynchronously.</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">spam_filter</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">comment_id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">remote_addr</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>To filter spam in comments we use <a class="reference external" href="http://akismet.com/faq/">Akismet</a>, the service
used to filter spam in comments posted to the free weblog platform
<cite>Wordpress</cite>.  <a class="reference external" href="http://akismet.com/faq/">Akismet</a> is free for personal use, but for commercial use you
need to pay.  You have to sign up to their service to get an API key.</p>
<p>To make API calls to <a class="reference external" href="http://akismet.com/faq/">Akismet</a> we use the <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> library written by
<a class="reference external" href="http://www.voidspace.org.uk/">Michael Foord</a>.</p>
</div>
<div class="section" id="blog-tasks-py">
<span id="task-example-blog-tasks"></span><h3><a class="toc-backref" href="#id47">blog/tasks.py</a><a class="headerlink" href="#blog-tasks-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">akismet</span> <span class="kn">import</span> <span class="n">Akismet</span>
<span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">spam_filter</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">spam_filter</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running spam filter for comment </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">comment_id</span><span class="p">)</span>

    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="n">current_domain</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
    <span class="n">akismet</span> <span class="o">=</span> <span class="n">Akismet</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AKISMET_KEY</span><span class="p">,</span> <span class="s">&quot;http://</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">domain</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;Invalid AKISMET_KEY&quot;</span><span class="p">)</span>


    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">user_ip</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">,</span>
                        <span class="n">comment_content</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                        <span class="n">comment_author</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">comment_author_email</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_spam</span><span class="p">:</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">is_spam</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="http://cloud.github.com/downloads/ask/celery/celery_favicon_128.png" alt="Logo"/>
</a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="overview.html"
                        title="previous chapter">Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="executing.html"
                        title="next chapter">Executing Tasks</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/userguide/tasks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="executing.html" title="Executing Tasks"
             >next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             >previous</a> |</li>
        <li><a href="../index.html">Celery v2.3.0rc2 documentation</a> &raquo;</li>
          <li><a href="index.html" >User Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2011, Ask Solem &amp; Contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>