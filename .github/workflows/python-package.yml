# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Celery

on:
  push:
    branches: [ 'main']
    paths:
        - '**.py'
        - '**.txt'
        - '.github/workflows/python-package.yml'
        - '**.toml'
        - "tox.ini"
  pull_request:
    branches: [ 'main' ]
    paths:
        - '**.py'
        - '**.txt'
        - '**.toml'
        - '.github/workflows/python-package.yml'
        - "tox.ini"
  workflow_dispatch:


permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
    BLM-347:
        timeout-minutes: 240
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

        steps:
            -   name: Fetch Docker Images
                run: |
                    docker pull redis:latest
                    docker pull rabbitmq:latest

            -   name: Install apt packages
                run: |
                    sudo apt update

            -   uses: actions/checkout@v4
            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v5
                with:
                    python-version: ${{ matrix.python-version }}
                    cache: 'pip'
                    cache-dependency-path: '**/setup.py'
            -   name: Install tox
                run: python -m pip install --upgrade pip tox tox-gh-actions
            -   name: >
                    Run tox for
                    "${{ matrix.python-version }}-smoke" -- -k test_blm_348 --reruns 0
                timeout-minutes: 10
                run: >
                    tox --verbose --verbose -e
                    "${{ matrix.python-version }}-smoke" -- -k test_blm_348 --reruns 0
