name: Docker

on:
    push:
      branches: [ 'main']
      paths:
          - '**.py'
          - '**.txt'
          - '**.toml'
          - './docker/**'
          - '.github/workflows/docker.yml'
    pull_request:
      branches: [ 'main']
      paths:
          - '**.py'
          - '**.txt'
          - '**.toml'
          - './docker/**'
          - '.github/workflows/docker.yml'


jobs:
  docker-build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4
    - name: Build Docker container
      run: make docker-build

  smoke-tests_celery4:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - name: "Build smoke tests container: celery4"
      run: docker build -f t/smoke/workers/celery4 .

  smoke-tests_dev:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - name: "Build smoke tests container: dev"
      run: docker build -f t/smoke/workers/dev .

  smoke-tests_latest:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - name: "Build smoke tests container: latest"
      run: docker build -f t/smoke/workers/latest .

  smoke-tests_pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - name: "Build smoke tests container: pypi"
      run: docker build -f t/smoke/workers/pypi --build-arg CELERY_VERSION="5.3" .